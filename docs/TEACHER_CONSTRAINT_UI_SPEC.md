# 教師管理UI改善仕様書

## 背景

現在の教師管理UIでは「順序制約（連続授業）」「その他の制約」といった抽象的な入力項目があり、利用者にとって分かりにくい。クライアントが自分で教師を追加し、複雑な制約を入力してもAIが柔軟に対応できるようにしたい。

## 現状の問題点

1. **入力項目が抽象的**
   - 「順序制約」「その他の制約」では何を入力すべきか不明確
   - 教師側の要望（NG欄、希望欄）と対応していない

2. **複雑な条件への対応が困難**
   - 期間による変動（例：4-6月は月火、7月以降は木金）
   - 特殊事情（例：妊娠で8月までに授業完了、検診日NG）
   - 他業務との兼ね合いによる細かな条件

## 提案仕様

### 1. UI簡略化（2項目のみ）

```
教師管理
├── 基本情報（名前、担当科目等）
├── NG制約（必ず守る条件）
│   └── 自由記述テキストエリア
└── 希望（できるだけ配慮する条件）
    └── 自由記述テキストエリア
```

### 2. 自動抽出とチップ化

#### 入力例と自動抽出

**NG欄の入力例**：
```
「4月から6月は金曜日NG」
「12/10-12/20は出張のため授業不可」
「毎週水曜日の1-2限は会議」
```

**自動抽出結果（チップ表示）**：
- `4/1-6/30` `金曜` `NG`
- `12/10-12/20` `全時限` `NG`
- `学期中` `水曜` `1-2限` `NG`

**希望欄の入力例**：
```
「なるべく月火に集中させてほしい」
「8月末までにすべての授業を終わらせたい」
「午前中（1-2限）が望ましい」
```

**自動抽出結果（チップ表示）**：
- `学期中` `月火` `優先`
- `締切:8/31` `前倒し配置`
- `学期中` `1-2限` `希望`

### 3. データモデル

```typescript
interface TeacherConstraintV2 {
  // 原文保存（監査・再編集用）
  ngText: string;
  preferenceText: string;
  
  // 構造化データ（エンジン用）
  rules: ConstraintRule[];
}

interface ConstraintRule {
  id: string;
  strength: 'HARD' | 'SOFT';  // NG=HARD, 希望=SOFT
  period?: {
    start: string;  // YYYY-MM-DD
    end: string;    // YYYY-MM-DD
  };
  days?: ('月'|'火'|'水'|'木'|'金')[];
  periods?: ('1限'|'2限'|'3限'|'4限')[];
  completeByDate?: string;  // 締切日
  confidence: number;  // 抽出信頼度 0-1
  note?: string;  // 補足情報
}
```

### 4. UI動作仕様

1. **テキスト入力時**
   - 自由記述でNG/希望を入力
   - フォーカスアウト時に自動解析

2. **チップ生成**
   - 抽出された期間・曜日・時限をチップ化
   - 信頼度低（<0.7）は黄色で「要確認」バッジ
   - ×ボタンで削除可能
   - クリックで編集モーダル表示

3. **期間未指定時**
   - デフォルトで「学期全体」を適用
   - チップには「学期中」と表示

4. **保存時**
   - 原文とJSON両方を保存
   - 変更履歴も記録

### 5. 対応可能なユースケース

#### ケース1：新任講師の期間別制約
```
NG: なし
希望: 4-6月は月火、7月以降は木金がいい
```
→ 2つの期間ルールに自動分割

#### ケース2：妊娠中の講師
```
NG: 6/10-12と7/8-9は検診
希望: 8月末までに全授業完了、午前中希望
```
→ 検診日NG + 締切設定 + 時限希望

#### ケース3：他業務との兼ね合い
```
NG: 水曜午前は定例会議
希望: なるべく月火に集めてほしい
```
→ 定期NG + 曜日集約希望

### 6. スケジューラーの処理

```javascript
// 1. HARD制約（NG）のフィルタリング
candidates = candidates.filter(slot => 
  !violatesHardConstraints(slot, teacher.rules)
);

// 2. SOFT制約（希望）のスコアリング
candidates.forEach(slot => {
  slot.score = calculatePreferenceScore(slot, teacher.rules);
});

// 3. 締切考慮の前倒し配置
if (hasDeadline(teacher.rules)) {
  prioritizeEarlierSlots(candidates, deadline);
}

// 4. 最高スコアの候補を選択
selected = candidates.sort((a, b) => b.score - a.score)[0];
```

### 7. エラー表示

配置不可の理由を明確に表示：
```
❌ 配置失敗：山田先生
  - 水曜1-2限はNG（定例会議）
  - 利用可能：月火木金の全時限、水曜3-4限

⚠️ 希望を満たせませんでした：
  - 月火希望でしたが、教室の都合で木曜に配置
```

### 8. 実装優先順位

1. **Phase 1**（MVP）
   - NG/希望の2項目UI
   - 基本的な曜日・時限の抽出
   - 手動でチップ編集

2. **Phase 2**（拡張）
   - 期間の自動抽出
   - 締切・前倒しロジック
   - 信頼度表示

3. **Phase 3**（高度化）
   - 自然言語処理の精度向上
   - 複雑な条件の解釈
   - 競合解決の提案

## 移行計画

1. **既存データの互換性**
   - 現在の制約データは自動でV2形式に変換
   - 旧UIも並行稼働（非推奨として）

2. **段階的ロールアウト**
   - フィーチャーフラグで新UIを制御
   - 一部の教師から試験運用

## まとめ

この仕様により：
- **入力が簡単**: NG/希望の2項目のみ
- **柔軟な表現**: 自由記述で複雑な条件も記載可能
- **AI対応**: 構造化データでスケジューラーが最適化
- **透明性**: なぜ配置できないかを明確に表示

クライアントが自力で教師を追加し、制約を入力しても、システムが自動で最適な時間割を生成できるようになる。

---

**ステータス**: 仕様検討中（実装待ち）
**最終更新**: 2025年8月21日
**次のアクション**: クライアントフィードバック後に実装検討